;/*********************************************************************************************************
;**
;**                                    中国软件开源组织
;**
;**                                   嵌入式实时操作系统
;**
;**                                       SylixOS(TM)
;**
;**                               Copyright  All Rights Reserved
;**
;**--------------文件信息--------------------------------------------------------------------------------
;**
;** 文   件   名: arm64MpCoreAsm.S
;**
;** 创   建   人: Wang.Xuan (王Q)
;**
;** 文件创建日期: 2018 年 06 月 29 日
;**
;** 描        述: ARM64 体系构架多核接口驱动.
;*********************************************************************************************************/

#ifndef ASSEMBLY
#define ASSEMBLY 1
#endif

#include <arch/assembler.h>
#include <arch/arm64/arch_regs.h>

#if LW_CFG_SMP_EN > 0

    FILE_BEGIN()
    
    IMPORT_LABEL(bspMpInt)
    
    EXPORT_LABEL(arm64MpidrGet)
    EXPORT_LABEL(archMpCur)
    EXPORT_LABEL(archMpInt)
    
    WEAK(arm64MpidrGet)
    WEAK(archMpCur)
    WEAK(archMpInt)

;/*********************************************************************************************************
;  获取当前核硬件 ID
;  对于 ARMv8 处理器，MPIDR 采用点分十进制的方式进行定义：
;  如 <Aff3>.<Aff2>.<Aff1>.<Aff0>
;*********************************************************************************************************/

FUNC_DEF(arm64MpidrGet)
    MRS     X1 , MPIDR_EL1
    AND     X0 , X1 , #0x3                                              ;/*  获取 Aff0 cpu id            */
    MOV     X3 , #0xff
    AND     X2 , X3 , X1, LSR #8
    ADD     X0 , X0 , X2, LSL #2                                        ;/*  获取 Aff1 cluster id        */
    AND     X2 , X3 , X1, LSR #16
    ADD     X0 , X0 , X2, LSL #4                                        ;/*  获取 Aff2 cluster id        */
    AND     X2 , X3 , X1, LSR #32
    ADD     X0 , X0 , X2, LSL #6                                        ;/*  获取 Aff3 cluster id        */
    RET
    FUNC_END()

;/*********************************************************************************************************
;  获取当前核 ID
;*********************************************************************************************************/

FUNC_DEF(archMpCur)
    MRS     X0 , TPIDR_EL1
    LDR     X0 , [X0 , #CPUID_OFFSET]
    RET
    FUNC_END()
    
;/*********************************************************************************************************
;  产生一次核间中断
;*********************************************************************************************************/

FUNC_DEF(archMpInt)
    B       bspMpInt
    FUNC_END()
    
    FILE_END()

#endif
;/*********************************************************************************************************
;  END
;*********************************************************************************************************/
