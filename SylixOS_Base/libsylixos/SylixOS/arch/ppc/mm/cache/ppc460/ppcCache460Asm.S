;/*********************************************************************************************************
;**
;**                                    中国软件开源组织
;**
;**                                   嵌入式实时操作系统
;**
;**                                       SylixOS(TM)
;**
;**                               Copyright  All Rights Reserved
;**
;**--------------文件信息--------------------------------------------------------------------------------
;**
;** 文   件   名: ppcCache460Asm.S
;**
;** 创   建   人: Jiao.JinXing (焦进星)
;**
;** 文件创建日期: 2019 年 08 月 21 日
;**
;** 描        述: PowerPC 460 体系构架 CACHE 驱动.
;*********************************************************************************************************/

#ifndef ASSEMBLY
#define ASSEMBLY 1
#endif

#include <arch/assembler.h>
#include <config/kernel/cache_cfg.h>

#if LW_CFG_CACHE_EN > 0

    EXPORT_LABEL(ppc460ICacheEnable)
    EXPORT_LABEL(ppc460DCacheEnable)

    EXPORT_LABEL(ppc460ICacheDisable)
    EXPORT_LABEL(ppc460DCacheDisable)

    EXPORT_LABEL(ppc460ICacheInvalidate)

    EXPORT_LABEL(ppc460DCacheInvalidate)
    EXPORT_LABEL(ppc460DCacheClear)
    EXPORT_LABEL(ppc460DCacheFlush)

    EXPORT_LABEL(ppc460ICacheInvalidateAll)
    EXPORT_LABEL(ppc460DCacheInvalidateAll)

    EXPORT_LABEL(ppc460TextUpdate)

    EXPORT_LABEL(ppc460BranchPredictionDisable)
    EXPORT_LABEL(ppc460BranchPredictionEnable)
    EXPORT_LABEL(ppc460BranchPredictorInvalidate)

;/*********************************************************************************************************
;  定义
;*********************************************************************************************************/

    FILE_BEGIN()

;/*********************************************************************************************************
;  使能 ICACHE
;*********************************************************************************************************/

FUNC_DEF(ppc460ICacheEnable)
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  使能 DCACHE
;*********************************************************************************************************/

FUNC_DEF(ppc460DCacheEnable)
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  禁能 ICACHE
;*********************************************************************************************************/

FUNC_DEF(ppc460ICacheDisable)
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  禁能 DCACHE
;*********************************************************************************************************/

FUNC_DEF(ppc460DCacheDisable)
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  DCACHE 所有数据无效
;*********************************************************************************************************/

FUNC_DEF(ppc460DCacheInvalidateAll)
    XOR     R0 , R0 , R0
    DCCCI   R0 , R0
    ISYNC
    SYNC
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  ICACHE 所有数据无效
;*********************************************************************************************************/

FUNC_DEF(ppc460ICacheInvalidateAll)
    XOR     R0 , R0 , R0
    ICCCI   R0 , R0
    ISYNC
    SYNC
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  无效 ICACHE R3=void *start; R4=void *end; R5=cache line size
;*********************************************************************************************************/

FUNC_DEF(ppc460ICacheInvalidate)
    XOR     R0 , R0 , R0
    ICBI    R0 , R3
    ADD     R3 , R3 , R5
    CMPLW   R3 , R4
    BLT     ppc460ICacheInvalidate

    ISYNC
    SYNC
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  将指定虚拟地址的 DCACHE 无效  R3=void *start; R4=void *end; R5=cache line size
;*********************************************************************************************************/

FUNC_DEF(ppc460DCacheInvalidate)
    XOR     R0 , R0 , R0
    DCBI    R0 , R3
    ADD     R3 , R3 , R5
    CMPLW   R3 , R4
    BLT     ppc460DCacheInvalidate

    SYNC
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  将指定虚拟地址的 DCACHE 回写并无效  R3=void *start; R4=void *end; R5=cache line size
;*********************************************************************************************************/

FUNC_DEF(ppc460DCacheClear)
    XOR     R0 , R0 , R0
    DCBF    R0 , R3                                 ;/*  PPC "flush" == SylixOS "clear"                  */
    ADD     R3 , R3 , R5
    CMPLW   R3 , R4
    BLT     ppc460DCacheClear

    SYNC
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  将指定虚拟地址的 DCACHE 回写  R3=void *start; R4=void *end; R5=cache line size
;*********************************************************************************************************/

FUNC_DEF(ppc460DCacheFlush)
    XOR     R0 , R0 , R0
    DCBST   R0 , R3                                 ;/*  PPC "store" == SylixOS "flush"                  */
    ADD     R3 , R3 , R5
    CMPLW   R3 , R4
    BLT     ppc460DCacheFlush

    SYNC                                            ;/*  Ensure all stores complete                      */
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  Text update
;*********************************************************************************************************/

FUNC_DEF(ppc460TextUpdate)
    XOR     R0 , R0 , R0
    DCBST   R0 , R3
    SYNC
    ICBI    R0 , R3
    ADD     R3 , R3 , R6
    CMPLW   R3 , R4
    BLT     ppc460TextUpdate

    ISYNC
    SYNC
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  禁能分支预测
;*********************************************************************************************************/

FUNC_DEF(ppc460BranchPredictionDisable)
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  使能分支预测
;*********************************************************************************************************/

FUNC_DEF(ppc460BranchPredictionEnable)
    BLR
    FUNC_END()

;/*********************************************************************************************************
;  无效分支预测
;*********************************************************************************************************/

FUNC_DEF(ppc460BranchPredictorInvalidate)
    BLR
    FUNC_END()

    FILE_END()

#endif
;/*********************************************************************************************************
;  END
;*********************************************************************************************************/
