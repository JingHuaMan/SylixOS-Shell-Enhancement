;/*********************************************************************************************************
;**
;**                                    中国软件开源组织
;**
;**                                   嵌入式实时操作系统
;**
;**                                       SylixOS(TM)
;**
;**                               Copyright  All Rights Reserved
;**
;**--------------文件信息--------------------------------------------------------------------------------
;**
;** 文   件   名: sparcAtomicAsm.S
;**
;** 创   建   人: Jiao.JinXing (焦进星)
;**
;** 文件创建日期: 2019 年 01 月 07 日
;**
;** 描        述: SPARC 体系构架原子量操作.
;*********************************************************************************************************/

#ifndef ASSEMBLY
#define ASSEMBLY 1
#endif

#include <arch/assembler.h>

    FILE_BEGIN()

#if LW_CFG_CPU_ATOMIC_EN > 0

    EXPORT_LABEL(archAtomicAdd)
    EXPORT_LABEL(archAtomicSub)
    EXPORT_LABEL(archAtomicAnd)
    EXPORT_LABEL(archAtomicOr)
    EXPORT_LABEL(archAtomicXor)

;/*********************************************************************************************************
;  原子量操作并返回结果
;*********************************************************************************************************/

#undef  ATOMIC_OP_RETURN
#define ATOMIC_OP_RETURN(op)     	\
1:  LD      [%o1], %g1;         	\
    op      %g1, %o0, %g7;       	\
    CASA    [%o1] 0xb, %g1, %g7;  	\
    CMP     %g1, %g7;             	\
    BNE     1b;                		\
    NOP;                         	\
    RETL;                      		\
    op      %g1, %o0, %o0;

;/*********************************************************************************************************
;  原子量加
;*********************************************************************************************************/

FUNC_DEF(archAtomicAdd)
    ATOMIC_OP_RETURN(add)
    FUNC_END(archAtomicAdd)

;/*********************************************************************************************************
;  原子量减
;*********************************************************************************************************/

FUNC_DEF(archAtomicSub)
    ATOMIC_OP_RETURN(sub)
    FUNC_END(archAtomicSub)

;/*********************************************************************************************************
;  原子量与
;*********************************************************************************************************/

FUNC_DEF(archAtomicAnd)
    ATOMIC_OP_RETURN(and)
    FUNC_END(archAtomicAnd)

;/*********************************************************************************************************
;  原子量或
;*********************************************************************************************************/

FUNC_DEF(archAtomicOr)
    ATOMIC_OP_RETURN(or)
    FUNC_END(archAtomicOr)

;/*********************************************************************************************************
;  原子量异或
;*********************************************************************************************************/

FUNC_DEF(archAtomicXor)
    ATOMIC_OP_RETURN(xor)
    FUNC_END(archAtomicXor)

#endif

    FILE_END()

;/*********************************************************************************************************
;  END
;*********************************************************************************************************/
