;/*********************************************************************************************************
;**
;**                                    中国软件开源组织
;**
;**                                   嵌入式实时操作系统
;**
;**                                       SylixOS(TM)
;**
;**                               Copyright  All Rights Reserved
;**
;**--------------文件信息--------------------------------------------------------------------------------
;**
;** 文   件   名: x86MmuAsm.S
;**
;** 创   建   人: Jiao.JinXing (焦进星)
;**
;** 文件创建日期: 2016 年 07 月 09 日
;**
;** 描        述: x86 体系构架 MMU 驱动.
;*********************************************************************************************************/

#ifndef ASSEMBLY
#define ASSEMBLY 1
#endif

#include <arch/assembler.h>
#include <config/kernel/vmm_cfg.h>

#if LW_CFG_VMM_EN > 0

    FILE_BEGIN()

    EXPORT_LABEL(x86MmuEnable)
    EXPORT_LABEL(x86MmuDisable)
    EXPORT_LABEL(x86MmuInvalidateTLB)
    EXPORT_LABEL(x86MmuInvalidateTLBMVA)

;/*********************************************************************************************************
;  使能 MMU
;*********************************************************************************************************/

FUNC_DEF(x86MmuEnable)
    MOVL    %CR0 , %EAX
    ORL     $(X86_CR0_PG | X86_CR0_WP) , %EAX                           ;/*  设置 PG 和 WP               */
    MOVL    %EAX , %CR0
    JMP     __x86MmuEnable                                              ;/*  排干预取队列                */
LINE_LABEL(__x86MmuEnable)
    RET
    FUNC_END(x86MmuEnable)

;/*********************************************************************************************************
;  禁能 MMU
;*********************************************************************************************************/

FUNC_DEF(x86MmuDisable)
    MOVL    %CR0 , %EAX
    ANDL    $(~(X86_CR0_PG | X86_CR0_WP)) , %EAX                        ;/*  清除 PG 和 WP               */
    MOVL    %EAX , %CR0
    JMP     __x86MmuDisable                                             ;/*  排干预取队列                */
LINE_LABEL(__x86MmuDisable)
    RET
    FUNC_END(x86MmuDisable)

;/*********************************************************************************************************
;  无效所有 TLB
;*********************************************************************************************************/

FUNC_DEF(x86MmuInvalidateTLB)
    MOVL    %CR3 , %EAX
    MOVL    %EAX , %CR3
    JMP     __x86MmuInvalidateTLB                                       ;/*  排干预取队列                */
LINE_LABEL(__x86MmuInvalidateTLB)
    RET
    FUNC_END(x86MmuInvalidateTLB)

;/*********************************************************************************************************
;  无效指定 MVA 的 TLB
;*********************************************************************************************************/

FUNC_DEF(x86MmuInvalidateTLBMVA)
    MOVL    X86_SP_ARG1(%ESP) , %EAX
    INVLPG  (%EAX)                                                      ;/*  无效 TLB 条目               */
    JMP     __x86MmuInvalidateTLBMVA                                    ;/*  排干预取队列                */
LINE_LABEL(__x86MmuInvalidateTLBMVA)
    RET
    FUNC_END(x86MmuInvalidateTLBMVA)

    FILE_END()

#endif
;/*********************************************************************************************************
;  END
;*********************************************************************************************************/
