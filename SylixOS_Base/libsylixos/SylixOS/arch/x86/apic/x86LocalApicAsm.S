;/*********************************************************************************************************
;**
;**                                    中国软件开源组织
;**
;**                                   嵌入式实时操作系统
;**
;**                                       SylixOS(TM)
;**
;**                               Copyright  All Rights Reserved
;**
;**--------------文件信息--------------------------------------------------------------------------------
;**
;** 文   件   名: x86LocalApicAsm.S
;**
;** 创   建   人: Jiao.JinXing (焦进星)
;**
;** 文件创建日期: 2016 年 07 月 04 日
;**
;** 描        述: x86 体系构架 Local APIC 相关源文件.
;*********************************************************************************************************/

#ifndef ASSEMBLY
#define ASSEMBLY 1
#endif

#include <arch/assembler.h>

    FILE_BEGIN()

    EXPORT_LABEL(x86LocalApicId)

;/*********************************************************************************************************
;  宏定义
;*********************************************************************************************************/

#define _X86_LOCAL_APIC_ID      0xfee00020                              /*  Local APIC ID 寄存器         */

#define _X86_CPU_INDEX_SHIFT    24                                      /*  需要向右移 24 位             */
#define _X86_CPU_INDEX_MASK     0xff                                    /*  宽度为 8 位                  */

;/*********************************************************************************************************
;  获得当前核 Local APIC ID
;*********************************************************************************************************/

FUNC_DEF(x86LocalApicId)
    MOVL    $_X86_LOCAL_APIC_ID , %EAX                                  ;/*  读 Local APIC ID 寄存器     */
    MOVL    0(%EAX) , %EAX
    ROR     $_X86_CPU_INDEX_SHIFT , %EAX                                ;/*  右移 _X86_CPU_INDEX_SHIFT   */
    ANDL    $_X86_CPU_INDEX_MASK  , %EAX                                ;/*  与上 _X86_CPU_INDEX_MASK    */
    RET
    FUNC_END(x86LocalApicId)

    FILE_END()

;/*********************************************************************************************************
;  END
;*********************************************************************************************************/
